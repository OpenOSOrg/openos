
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>36. Cooperating Processes and Inter-process Communication &#8212; Introduction to Operating Systems</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script async="async" kind="hypothesis" src="https://hypothes.is/embed.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="37. The Critical Section Problem" href="criticalsection.html" />
    <link rel="prev" title="35. Introduction to Concurrency, Synchronization and Deadlock" href="sync.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Introduction to Operating Systems</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro/pref.html">
                    Preface
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Getting started
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../intro/intro.html">
   1. Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../intro/purpose.html">
   2. Purpose of operating systems
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../intro/structure.html">
   3. Operating System Structure &amp; Unix/Linux
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../intro/abstractions.html">
   4. Operating System Abstractions
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../intro/tools.html">
   5. What you should know
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../intro/tools-c.html">
     5.1. The C Programming Language
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../intro/tools-shell.html">
     5.2. Shell
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../intro/tools-editors.html">
     5.3. Editors
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../intro/tools-make.html">
     5.4. Make
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../intro/tools-testing.html">
     5.5. Testing
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../intro/tools-git.html">
     5.6. Git Basics
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../intro/tools-gdb.html">
     5.7. GDB
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Virtual Processor
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../scheduling/intro.html">
   6. Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../scheduling/process.html">
   7. The Process: A virtual Computer
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../scheduling/virtual.html">
   8. Virtualizing the CPU
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../scheduling/threads.html">
   9. The Thread: A Virtual CPU
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../scheduling/scheduling.html">
   10. Scheduling
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../scheduling/sch-goals.html">
     10.1. Scheduling Goals
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../scheduling/sch-simple.html">
     10.2. Simple Examples of Scheduling Policies
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../scheduling/sch-real.html">
     10.3. A Look at the Linux Scheduler
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../scheduling/review.html">
   11. Review Questions
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Virtual Memory
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../mm/intro.html">
   12. Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../mm/phys-and-seg.html">
   13. Memory management before paged virtual memory
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../mm/virt-paging.html">
   14. Paging
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../mm/page-tables.html">
   15. Page Tables
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../mm/reclamation.html">
   16. Memory reclaiming algorithms.
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../mm/page-size.html">
   17. Page Sizes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../mm/misc.html">
   18. Other topics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../mm/buffer-cache.html">
   19. Buffer Cache
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../mm/pagefaults.html">
   20. Memory Management Page Faults
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../mm/realworld.html">
   21. Memory management in the real world
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../mm/concl.html">
   22. Conclusion
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../mm/review.html">
   23. Review
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  File Systems
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../fs/intro.html">
   24. Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../fs/interface.html">
   25. File System Abstraction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../fs/diskhw.html">
   26. A bit about Disks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../fs/disklayout.html">
   27. File System Layout
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../fs/dl_track_used.html">
   28. Disk Layout:Tracking Used Space
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../fs/dl_track_free.html">
   29. Disk Layout:Tracking Free Space
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../fs/dl_name.html">
   30. Disk Layout:Implementing Name Space
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../fs/dl_failures.html">
   31. Disk Layout:Dealing with Failures
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../fs/dl_ex_exx.html">
   32. Disk Layout:Examples of Real World File Systems
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../fs/kernelimp.html">
   33. Kernel implementation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../fs/review.html">
   34. Review
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Concurrency
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="sync.html">
   35. Introduction to Concurrency, Synchronization and Deadlock
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   36. Cooperating Processes and Inter-process Communication
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="criticalsection.html">
   37. The Critical Section Problem
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="locks.html">
   38. Implementing Locks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="ordering.html">
   39. Ordering Thread Events
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="concurrency_bugs.html">
   40. Common Concurrency Bugs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="readmostly.html">
   41. Read-Dominated Workloads
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="hardware_challenges.html">
   42. Challenges of Modern Hardware
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="linux_locking.html">
   43. Locking in the Linux Kernel
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="review.html">
   44. Review
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Other Topics
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../devices/devices.html">
   45. Input and Output
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../devices/disk2.html">
   46. More on Disks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../virt/virt.html">
   47. Virtualization
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../sec/sec.html">
   48. Security
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Appendices
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../misc/howto.html">
   49. How to read this book
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../contributing/intro.html">
   50. Contributing
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../contributing/examples.html">
     50.1. Examples
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../contributing/credit.html">
     50.2. Contributors
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../contributing/Contributing.html">
     50.3. Contributing
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../contributing/resources.html">
     50.4. Resources to look at
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../contributing/fix.html">
     50.5. Out of date
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../misc/bib.html">
   51. Bibliography
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://jupyterhub-opf-jupyterhub.apps.smaug.na.operate-first.cloud/hub/user-redirect/git-pull?repo=https%3A//github.com/OpenOSOrg/openos&urlpath=lab/tree/openos/content/sync/sharing.ipynb&branch=main"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on JupyterHub"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../_static/images/logo_jupyterhub.svg">
  </span>
<span class="headerbtn__text-container">JupyterHub</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/OpenOSOrg/openos"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/OpenOSOrg/openos/issues/new?title=Issue%20on%20page%20%2Fsync/sharing.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/OpenOSOrg/openos/edit/main/content/sync/sharing.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Edit this page"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="headerbtn__text-container">suggest edit</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/sync/sharing.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#shared-memory">
   36.1. Shared Memory
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#multi-threaded-processes">
   36.2. Multi-threaded Processes
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#issues-with-concurrent-execution">
   36.3. Issues with Concurrent Execution
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#race-conditions">
   36.4. Race Conditions
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Cooperating Processes and Inter-process Communication</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#shared-memory">
   36.1. Shared Memory
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#multi-threaded-processes">
   36.2. Multi-threaded Processes
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#issues-with-concurrent-execution">
   36.3. Issues with Concurrent Execution
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#race-conditions">
   36.4. Race Conditions
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <div class="cell tag_remove-input docutils container">
</div>
<section class="tex2jax_ignore mathjax_ignore" id="cooperating-processes-and-inter-process-communication">
<span id="cont-sync-sharing"></span><h1><span class="section-number">36. </span>Cooperating Processes and Inter-process Communication<a class="headerlink" href="#cooperating-processes-and-inter-process-communication" title="Permalink to this headline">#</a></h1>
<p>The process abstraction is designed to give the illusion that a program executes on its own
private, isolated (virtual) machine. The OS scheduling mechanism hides the fact that the
physical CPU is, in fact, shared by multiple processes. From the perspective of any given
process, it appears as though its instructions execute one after the other, in the order
that they appear in the program, on a dedicated CPU, without interruption or interference
by the execution of other processes. The process also has sole access to a virtual address
space, where it can store, and operate on, its data – there is no concern about access to
the process’s memory from other processes, or that the process may inadvertently access
memory that does not belong to it.</p>
<p>But, sometimes we want multiple processes to work together to solve a problem. How can they
cooperate if they are completely isolated from each other? The short answer is, they can’t. For processes to cooperate, they need some way to communicate with each other, so that they can exchange information and coordinate their activities. Let’s think about some ways that multiple processes can work together, and how they can communicate.</p>
<dl class="simple myst">
<dt><a class="reference internal" href="../intro/abstractions.html#cont-gs-abstractions-pipes"><span class="std std-ref">Unix command pipelines</span></a></dt><dd><p>Each program is designed to do one thing well, and more complex operations can be created by composing multiple simple programs. Here, communication is supported by the <code class="docutils literal notranslate"><span class="pre">pipe()</span></code> system call, which creates a communication channel between processes. With some manipulation of file descriptors, the shell can arrange for the standard output of one process to become the standard input of the next process in the pipeline. The pipe provides both a way to pass data from one process to the next and a way to control the order in which processes execute, because a downstream process cannot read its input until after the previous process in the pipeline has started to produce some output.</p>
</dd>
<dt>Complex services</dt><dd><p>A complex service, such as a banking service, may have multiple logical operations that it needs to carry out, such as handling user input, executing account operations like deposits, calculating daily interest, running fraud detection analytics, etc. It is often convenient to implement the service as a collection of processes, with each process carrying out one of the major tasks of the service and the operating system <a class="reference internal" href="../scheduling/scheduling.html#cont-vp-scheduling"><span class="std std-ref">scheduler</span></a> ensuring that all tasks make progress concurrently. The processes may communicate by reading and writing shared files in the file system. By</p>
</dd>
<dt>Parallel computation</dt><dd><p>In this case, the goal is to complete a single task in less time by using multiple physical compute cores. As a trivial example, consider sorting a very large set of values. On a multi-core machine, you could create one process per core, arrange for each process to sort a portion of the input, and then merge the results together after all the individual sorts were complete. Here, processes might communicate using a combination of files in the file system (e.g., to read the original, unsorted input, and write the intermediate results from each sorting process) and pipes (e.g., to notify the merging process when each sorting process was finished).</p>
</dd>
</dl>
<section id="shared-memory">
<h2><span class="section-number">36.1. </span>Shared Memory<a class="headerlink" href="#shared-memory" title="Permalink to this headline">#</a></h2>
<p>To support more efficient, fine-grained inter-process communication, the operating system also provides system calls to let processes explicitly share a portion of their virtual address space. This allows processes to exchange information simply by reading or writing variables that are allocated in the shared part of the address space. There are actually two ways to do this on Unix systems. The first comes from UNIX System V:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">segment_id</span> <span class="pre">=</span> <span class="pre">shmget(key,</span> <span class="pre">size,</span> <span class="pre">shmflg)</span></code> : return the identifier of the System V shared memory segment associated with the value of the argument <code class="docutils literal notranslate"><span class="pre">key</span></code>; may be used either to obtain the identifier of a previously created shared memory segment (when <code class="docutils literal notranslate"><span class="pre">shmflg</span></code> is zero and <code class="docutils literal notranslate"><span class="pre">key</span></code> does not have the value <code class="docutils literal notranslate"><span class="pre">IPC_PRIVATE</span></code>), or to create a new shared memory segment.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">shared_startvaddr</span> <span class="pre">=</span> <span class="pre">shmat(shmid,</span> <span class="pre">*shmaddr,</span> <span class="pre">shmflg)</span></code> : attach the System V shared memory segment identified by <code class="docutils literal notranslate"><span class="pre">shmid</span></code> to the address space of the calling process at <code class="docutils literal notranslate"><span class="pre">shmaddr</span></code> or an address chosen by the OS if <code class="docutils literal notranslate"><span class="pre">shmaddr</span></code> is <code class="docutils literal notranslate"><span class="pre">NULL</span></code>; return the actual starting virtual address of the shared segment in the process address space.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">err</span> <span class="pre">=</span> <span class="pre">shmdt(shmaddr)</span></code> : detach the shared memory segment located at the address specified by <code class="docutils literal notranslate"><span class="pre">shmaddr</span></code> from the address space of the calling process; the to-be-detached segment must be currently attached with <code class="docutils literal notranslate"><span class="pre">shmaddr</span></code> equal to the value returned by the attaching <code class="docutils literal notranslate"><span class="pre">shmat()</span></code> call.</p></li>
</ul>
<p>The use of segment identifiers makes it possible for unrelated processes to share memory, however after one process creates a shared memory segment with <code class="docutils literal notranslate"><span class="pre">shmget</span></code>, it needs to communicate the segment id to the other processes that are allowed to share it. One way to do this is by writing the segment id into a file that can be read by the other processes. The other method for requesting shared memory comes from BSD UNIX and requires a parent process to create a shared mapping in its address space before forking child processes. The mapped segments are then shared with child processes, rather than creating a copy in the child address space.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">shared_startvaddr</span> <span class="pre">=</span> <span class="pre">mmap(*addr,</span> <span class="pre">length,</span> <span class="pre">prot,</span> <span class="pre">MAP_SHARED</span> <span class="pre">|</span> <span class="pre">MAP_ANONYMOUS,</span> <span class="pre">...)</span></code> : create a new mapping of <code class="docutils literal notranslate"><span class="pre">length</span></code> bytes in the virtual address space of the calling process starting at  <code class="docutils literal notranslate"><span class="pre">addr</span></code> or an address chosen by the OS if <code class="docutils literal notranslate"><span class="pre">addr</span></code> is <code class="docutils literal notranslate"><span class="pre">NULL</span></code>; return the actual starting virtual address of the shared segment in the process address space.</p></li>
</ul>
<p>Note that <code class="docutils literal notranslate"><span class="pre">mmap</span></code> is often used to access persistent files using a virtual memory interface rather than the file system <code class="docutils literal notranslate"><span class="pre">read()</span></code> and <code class="docutils literal notranslate"><span class="pre">write()</span></code> interface. In the example above, <code class="docutils literal notranslate"><span class="pre">MAP_ANONYMOUS</span></code> indicates that the mapping is for a non-persistent virtual memory region, which is not backed by any file. (Remember that you can use <code class="docutils literal notranslate"><span class="pre">man</span></code> for the full details of these system calls.)</p>
<p>The shared memory segments are implemented in the operating system using the virtual memory mechanisms. Each process that shares the memory segment has its page tables pointing to the same underlying physical pages, so that any load or store access to a virtual address in the shared segment will be translated to the same physical location in the machine memory.</p>
</section>
<section id="multi-threaded-processes">
<span id="cont-sync-sharing-shared-mem"></span><h2><span class="section-number">36.2. </span>Multi-threaded Processes<a class="headerlink" href="#multi-threaded-processes" title="Permalink to this headline">#</a></h2>
<p>Recall from <a class="reference internal" href="../scheduling/threads.html#cont-vp-threads"><span class="std std-numref">Section 9</span></a> that a process can have multiple <em>threads</em>, and that all threads in a process share the same virtual address space. This means that multi-threaded processes do not need to do any extra work to communicate using shared memory. The operating system itself is multi-threaded: every user-level process has at least one thread in the kernel, and other threads carry out asynchronous operating system activities, such as writing dirty file system blocks back to the disk. All of these kernel threads share the same operating system code and data structures. We will see later how user-level communication through pipes is implemented in the operating system by threads writing to, and reading from, a shared buffer of memory. In our discussion of concurrency and synchronization, we will use examples in multi-threaded user-level processes, since they can be presented as simple, stand-alone programs. Keep in mind that everything we say about multi-threaded processes also applies to the implementation of the operating system.</p>
<p>Since each thread is an independent execution entity, they need to have their own execution state. This includes a per-thread execution stack to hold local variables. In contrast, global variables and heap-allocated variables are shared by all threads in a process. Note that although each thread has its own execution stack, these are still all part of the same virtual address space, and threads in the same process are not protected from each other by the operating system. Thus, it is possible for a buggy thread to accidentally scribble on another thread’s stack space, leading to bizarre behavior.</p>
</section>
<section id="issues-with-concurrent-execution">
<span id="cont-sync-sharing-issues"></span><h2><span class="section-number">36.3. </span>Issues with Concurrent Execution<a class="headerlink" href="#issues-with-concurrent-execution" title="Permalink to this headline">#</a></h2>
<p>Regardless of whether we are using multiple processes, or a single multi-threaded process, whether we are implementing user-level programs or the operating system, we need a way to coordinate multiple concurrent activities.</p>
<aside class="sidebar">
<p><em>Concurrency</em> in computer systems means that the execution of multiple (i.e., two or more) tasks <em>overlaps in time</em>. The context switch mechanism gives us concurrent execution of multiple processes, even on a single physical CPU. <em>Parallelism</em> means that multiple tasks are executing <em>at the same time</em>. Parallelism requires multiple physical CPUs.</p>
</aside>
<p>The operating system scheduler controls when, and for how long, any given thread is allowed to execute. Although each thread’s instructions execute in program order, its execution is interleaved with other threads. And when threads share resources, such as data structures in shared memory, the arbitrary interleaving of operations from multiple threads can lead to unpredictable, and undesirable, outcomes. <strong>Synchronization</strong> is the mechanism that allows us to restrict the possible interleavings of threads, so that we can control how they use shared resources, reason about their behavior, and prevent undesirable outcomes. There are two main problems that synchronization helps us to solve: how to ensure that threads do not interfere with each other when they use a shared resource, and how to ensure that threads execute their operations in the correct order. For example, consider the simple program in <a class="reference internal" href="#listing-sync-outputs"><span class="std std-numref">Listing 36.1</span></a>, below, in which two threads each output a string:</p>
<div class="literal-block-wrapper docutils container" id="listing-sync-outputs">
<div class="code-block-caption"><span class="caption-number">Listing 36.1 </span><span class="caption-text">output_example.c - Uncontrolled thread interleaving example using output to the terminal.</span><a class="headerlink" href="#listing-sync-outputs" title="Permalink to this code">#</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1">#include &lt;pthread.h&gt;</span>
<span class="linenos"> 2</span><span class="c1">#include &lt;stdlib.h&gt;</span>
<span class="linenos"> 3</span><span class="c1">#include &lt;sys/types.h&gt;</span>
<span class="linenos"> 4</span><span class="c1">#include &lt;unistd.h&gt;</span>
<span class="linenos"> 5</span><span class="c1">#include &lt;string.h&gt;</span>
<span class="linenos"> 6</span><span class="c1">#include &lt;stdio.h&gt;</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="o">/*</span> <span class="n">This</span> <span class="n">function</span> <span class="ow">is</span> <span class="n">intended</span> <span class="n">so</span> <span class="n">simulate</span> <span class="n">a</span> <span class="n">thread</span> <span class="n">needing</span> <span class="n">to</span> <span class="n">do</span> <span class="n">some</span> <span class="n">other</span> 
<span class="linenos"> 9</span> <span class="o">*</span> <span class="n">work</span> <span class="ow">in</span> <span class="n">between</span> <span class="n">output</span> <span class="n">statements</span><span class="o">.</span>
<span class="linenos">10</span> <span class="o">*/</span>
<span class="linenos">11</span><span class="n">static</span> <span class="n">long</span> <span class="n">waste_cpu</span><span class="p">()</span>
<span class="linenos">12</span><span class="p">{</span>
<span class="linenos">13</span>    <span class="n">long</span> <span class="n">dummy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="linenos">14</span>    <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">15</span>        <span class="n">dummy</span> <span class="o">+=</span> <span class="n">rand</span><span class="p">();</span>
<span class="linenos">16</span>    <span class="p">}</span>
<span class="linenos">17</span>    <span class="k">return</span> <span class="n">dummy</span><span class="p">;</span>
<span class="linenos">18</span><span class="p">}</span>
<span class="linenos">19</span>
<span class="linenos">20</span><span class="o">/*</span> <span class="n">Start</span> <span class="n">of</span> <span class="n">function</span> <span class="n">executed</span> <span class="n">by</span> <span class="n">each</span> <span class="n">thread</span><span class="o">.</span>
<span class="linenos">21</span> <span class="o">*</span> <span class="n">Each</span> <span class="n">character</span> <span class="n">of</span> <span class="n">the</span> <span class="n">argument</span> <span class="n">string</span> <span class="ow">is</span> <span class="n">printed</span> <span class="n">out</span> <span class="n">one</span><span class="o">-</span><span class="n">by</span><span class="o">-</span><span class="n">one</span>
<span class="linenos">22</span> <span class="o">*</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">separate</span> <span class="n">system</span> <span class="n">call</span><span class="o">.</span> 
<span class="linenos">23</span> <span class="o">*</span> <span class="n">To</span> <span class="n">increase</span> <span class="n">the</span> <span class="n">number</span> <span class="n">of</span> <span class="n">interleavings</span><span class="p">,</span> <span class="n">we</span> <span class="n">voluntarily</span> <span class="k">yield</span> <span class="n">the</span> 
<span class="linenos">24</span> <span class="o">*</span> <span class="n">CPU</span> <span class="n">after</span> <span class="n">each</span> <span class="n">character</span> <span class="ow">is</span> <span class="n">output</span><span class="o">.</span>
<span class="linenos">25</span> <span class="o">*/</span>
<span class="hll"><span class="linenos">26</span><span class="n">static</span> <span class="n">void</span> <span class="o">*</span><span class="n">write_one_by_one</span><span class="p">(</span><span class="n">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
</span><span class="hll"><span class="linenos">27</span><span class="p">{</span>
</span><span class="hll"><span class="linenos">28</span>    <span class="n">char</span> <span class="o">*</span><span class="n">mystr</span> <span class="o">=</span> <span class="p">(</span><span class="n">char</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
</span><span class="hll"><span class="linenos">29</span>      
</span><span class="hll"><span class="linenos">30</span>    <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">strlen</span><span class="p">(</span><span class="n">mystr</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll"><span class="linenos">31</span>        <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mystr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span> 
</span><span class="hll"><span class="linenos">32</span>        <span class="n">waste_cpu</span><span class="p">();</span>
</span><span class="hll"><span class="linenos">33</span>    <span class="p">}</span>
</span><span class="hll"><span class="linenos">34</span>  
</span><span class="hll"><span class="linenos">35</span>    <span class="k">return</span> <span class="p">(</span><span class="n">void</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">;</span>       
</span><span class="hll"><span class="linenos">36</span><span class="p">}</span>
</span><span class="linenos">37</span><span class="o">/*</span> <span class="n">End</span> <span class="n">of</span> <span class="n">function</span> <span class="n">executed</span> <span class="n">by</span> <span class="n">each</span> <span class="n">thread</span><span class="o">.</span> <span class="o">*/</span>
<span class="linenos">38</span>
<span class="linenos">39</span>
<span class="linenos">40</span><span class="nb">int</span> <span class="n">main</span><span class="p">(</span><span class="nb">int</span> <span class="n">argc</span><span class="p">,</span> <span class="n">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="linenos">41</span><span class="p">{</span>
<span class="linenos">42</span>    <span class="n">pthread_t</span> <span class="n">tid1</span><span class="p">,</span> <span class="n">tid2</span><span class="p">;</span>
<span class="linenos">43</span>    <span class="n">char</span> <span class="o">*</span><span class="n">str1</span> <span class="o">=</span> <span class="s2">&quot;Hello&quot;</span><span class="p">;</span>
<span class="linenos">44</span>    <span class="n">char</span> <span class="o">*</span><span class="n">str2</span> <span class="o">=</span> <span class="s2">&quot;Goodbye&quot;</span><span class="p">;</span>
<span class="linenos">45</span>
<span class="linenos">46</span>    <span class="o">/*</span> <span class="n">Normally</span> <span class="n">we</span><span class="s1">&#39;d want to test the return value of pthread_create. */</span>
<span class="linenos">47</span>
<span class="hll"><span class="linenos">48</span>    <span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid1</span><span class="p">,</span> <span class="n">NULL</span><span class="p">,</span> <span class="n">write_one_by_one</span><span class="p">,</span> <span class="p">(</span><span class="n">void</span> <span class="o">*</span><span class="p">)</span><span class="n">str1</span> <span class="p">);</span>
</span><span class="hll"><span class="linenos">49</span>    <span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid2</span><span class="p">,</span> <span class="n">NULL</span><span class="p">,</span> <span class="n">write_one_by_one</span><span class="p">,</span> <span class="p">(</span><span class="n">void</span> <span class="o">*</span><span class="p">)</span><span class="n">str2</span> <span class="p">);</span>
</span><span class="linenos">50</span>
<span class="linenos">51</span>    <span class="o">/*</span> <span class="n">Wait</span> <span class="k">for</span> <span class="n">child</span> <span class="n">threads</span> <span class="n">to</span> <span class="n">finish</span> <span class="o">*/</span>
<span class="linenos">52</span>    <span class="n">pthread_join</span><span class="p">(</span><span class="n">tid1</span><span class="p">,</span> <span class="n">NULL</span><span class="p">);</span>
<span class="linenos">53</span>    <span class="n">pthread_join</span><span class="p">(</span><span class="n">tid2</span><span class="p">,</span> <span class="n">NULL</span><span class="p">);</span>
<span class="linenos">54</span>
<span class="linenos">55</span>    <span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>    
<span class="linenos">56</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="linenos">57</span><span class="p">}</span>
<span class="linenos">58</span>
</pre></div>
</div>
</div>
<p>When this program is run, the main function creates two new threads, passing each a string to output on the terminal. Once created, the threads start executing concurrently in the <code class="docutils literal notranslate"><span class="pre">write_one_by_one</span></code> function. Each thread loops over its input string, calling the <code class="docutils literal notranslate"><span class="pre">write()</span></code> system call to output the characters one by one. (We could, of course, call <code class="docutils literal notranslate"><span class="pre">write()</span></code> to output the entire string at once, or use the C library <code class="docutils literal notranslate"><span class="pre">printf</span></code> function, but we want to see what could happen when we don’t have the internal synchronization that these functions provide.)</p>
<p>What do you expect the result of running this program to be? Let’s give it a try a few times!</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "91b2bdf7084c448f9e6e92b658f5b331", "version_major": 2, "version_minor": 0}
</script></div>
</div>
<p>The output doesn’t look great. Not only is the output unreadable, it is also different from one run to the next. (And each time we build this book, we don’t know exactly what output you will be seeing! Maybe some of the runs even produce something reasonable.) What we want to see is either “HelloGoodbye” or “GoodbyeHello” — by adding synchronization, we can restrict the interleavings of the output to just these two possibilities. And, if we wanted to ensure that “Hello” always appeared on the terminal before “Goodbye”, another form of synchronization would allow us to enforce that ordering as well. In fact, the C library <code class="docutils literal notranslate"><span class="pre">printf()</span></code> family of functions, and the internal implementation of the <code class="docutils literal notranslate"><span class="pre">write()</span></code> system call, contain synchronization to ensure that output from one call is not interleaved with another, but if we wanted to ensure that “Hello” is displayed before “Goodbye”, we would still need to add more synchronization on top of the <code class="docutils literal notranslate"><span class="pre">write()</span></code> or <code class="docutils literal notranslate"><span class="pre">printf()</span></code> functions.</p>
<p>Let’s look at another illustrative example of the problems that can arise when we don’t control concurrent execution.</p>
<div class="literal-block-wrapper docutils container" id="listing-sync-bank">
<div class="code-block-caption"><span class="caption-number">Listing 36.2 </span><span class="caption-text">deposit function from bank_deposit.c - Simple bank account example.</span><a class="headerlink" href="#listing-sync-bank" title="Permalink to this code">#</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="n">static</span> <span class="n">void</span> <span class="n">deposit</span><span class="p">(</span><span class="nb">int</span> <span class="n">account</span><span class="p">,</span> <span class="n">money_t</span> <span class="n">amount</span><span class="p">)</span>
<span class="linenos">2</span><span class="p">{</span>
<span class="linenos">3</span>    <span class="n">money_t</span> <span class="n">balance</span> <span class="o">=</span> <span class="n">get_balance</span><span class="p">(</span><span class="n">account</span><span class="p">);</span>
<span class="linenos">4</span>    <span class="n">balance</span> <span class="o">+=</span> <span class="n">amount</span><span class="p">;</span>
<span class="linenos">5</span>    <span class="n">put_balance</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">balance</span><span class="p">);</span>
<span class="linenos">6</span>
<span class="linenos">7</span>    <span class="k">return</span><span class="p">;</span>        
<span class="linenos">8</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p>In <a class="reference internal" href="#listing-sync-bank"><span class="std std-numref">Listing 36.2</span></a> we see a simplified example of a function that is part of a program to
maintain a bank account balance at the Bank of Lost Funds. When running
on a single thread, the <code class="docutils literal notranslate"><span class="pre">deposit</span></code> function is trivially correct: after it
completes execution, the value of <code class="docutils literal notranslate"><span class="pre">balance</span></code> stored back to the <code class="docutils literal notranslate"><span class="pre">account</span></code> will be <code class="docutils literal notranslate"><span class="pre">amount</span></code> greater than
it was before the function was invoked. Problems arise, however, when multiple threads run this function concurrently.</p>
<figure class="align-default" id="fig-sync-badbank">
<a class="reference internal image-reference" href="../_images/bank_deposit_interleaving.drawio.png"><img alt="../_images/bank_deposit_interleaving.drawio.png" src="../_images/bank_deposit_interleaving.drawio.png" style="width: 85%;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 36.1 </span><span class="caption-text">(a) The body of the <code class="docutils literal notranslate"><span class="pre">deposit()</span></code> function executed by two threads, (b) one possible interleaving of the execution of the threads, and (c) a second possible interleaving.</span><a class="headerlink" href="#fig-sync-badbank" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>In <a class="reference internal" href="#fig-sync-badbank"><span class="std std-numref">Fig. 36.1</span></a>(b), we see one possible interleaving when
this function is invoked by two threads nearly simultaneously. In this
case Thread 1 is interrupted after it has read the current value of
<code class="docutils literal notranslate"><span class="pre">balance</span></code>, but before it could store the new value back to memory. Thread 2 then gets to run and completes its execution of the <code class="docutils literal notranslate"><span class="pre">deposit()</span></code> function before being interrupted. Finally, Thread 1 can run again and complete its execution of <code class="docutils literal notranslate"><span class="pre">deposit()</span></code> by storing its local <code class="docutils literal notranslate"><span class="pre">balance</span></code> variable back to the account. The
result is that the update performed by Thread 2 is lost, being
over-written by Thread 1’s computation. After depositing a total of
$150 to the account we have a final balance of $50. Context switches are unpredictable, however, and other interleavings of the thread executions are also possible. In <a class="reference internal" href="#fig-sync-badbank"><span class="std std-numref">Fig. 36.1</span></a>(c) we see another possible schedule, where Thread 1’s update to the account balance is overwritten by Thread 2.</p>
<p>Let’s try running the bank deposit program a few times and see what happens.</p>
<div class="dropdown admonition">
<p class="admonition-title">Click to show the full source code of the bank balance program.</p>
<p>Here is the complete code for the bank balance example, including the creation of two threads to run the deposit function on the same account with different amounts.</p>
<div class="literal-block-wrapper docutils container" id="listing-sync-bank-full">
<div class="code-block-caption"><span class="caption-number">Listing 36.3 </span><span class="caption-text">bank_deposit.c - Full source code for simple bank account example</span><a class="headerlink" href="#listing-sync-bank-full" title="Permalink to this code">#</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="c1">#include &lt;pthread.h&gt;</span>
<span class="linenos">  2</span><span class="c1">#include &lt;stdlib.h&gt;</span>
<span class="linenos">  3</span><span class="c1">#include &lt;sys/types.h&gt;</span>
<span class="linenos">  4</span><span class="c1">#include &lt;unistd.h&gt;</span>
<span class="linenos">  5</span><span class="c1">#include &lt;string.h&gt;</span>
<span class="linenos">  6</span><span class="c1">#include &lt;stdio.h&gt;</span>
<span class="linenos">  7</span>
<span class="linenos">  8</span><span class="c1">#define money_t double</span>
<span class="linenos">  9</span><span class="c1">#define MAX_ACCOUNTS 1000</span>
<span class="linenos"> 10</span>
<span class="linenos"> 11</span><span class="n">struct</span> <span class="n">deposit_s</span> <span class="p">{</span>
<span class="linenos"> 12</span>    <span class="nb">int</span> <span class="n">account_num</span><span class="p">;</span>
<span class="linenos"> 13</span>    <span class="n">money_t</span> <span class="n">amount</span><span class="p">;</span>
<span class="linenos"> 14</span><span class="p">};</span>
<span class="linenos"> 15</span>
<span class="linenos"> 16</span><span class="n">money_t</span> <span class="n">accounts</span><span class="p">[</span><span class="n">MAX_ACCOUNTS</span><span class="p">];</span>
<span class="linenos"> 17</span>
<span class="linenos"> 18</span><span class="o">/*</span> <span class="n">This</span> <span class="n">function</span> <span class="ow">is</span> <span class="n">intended</span> <span class="n">so</span> <span class="n">simulate</span> <span class="n">the</span> <span class="n">work</span> <span class="n">of</span> <span class="n">retrieving</span> <span class="n">the</span> <span class="n">current</span> <span class="n">balance</span>
<span class="linenos"> 19</span> <span class="o">*</span> <span class="k">for</span> <span class="n">a</span> <span class="n">given</span> <span class="n">account</span> <span class="n">number</span><span class="o">.</span> <span class="n">It</span> <span class="n">just</span> <span class="n">spins</span> <span class="ow">and</span> <span class="n">yields</span> <span class="n">a</span> <span class="n">random</span> <span class="n">number</span> <span class="n">of</span> <span class="n">times</span><span class="o">.</span>
<span class="linenos"> 20</span> <span class="o">*/</span>
<span class="linenos"> 21</span><span class="n">static</span> <span class="n">money_t</span> <span class="n">get_balance</span><span class="p">(</span><span class="nb">int</span> <span class="n">account_num</span><span class="p">)</span>
<span class="linenos"> 22</span><span class="p">{</span>
<span class="linenos"> 23</span>    <span class="n">long</span> <span class="n">dummy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 24</span>    <span class="nb">int</span> <span class="n">nyield</span> <span class="o">=</span> <span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="mi">10</span><span class="p">;</span>
<span class="linenos"> 25</span>    <span class="nb">int</span> <span class="n">nspin</span> <span class="o">=</span> <span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">;</span>
<span class="linenos"> 26</span>
<span class="linenos"> 27</span>
<span class="linenos"> 28</span>    <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nyield</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos"> 29</span>        <span class="n">sched_yield</span><span class="p">();</span>
<span class="linenos"> 30</span>        <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">nspin</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos"> 31</span>            <span class="n">dummy</span> <span class="o">+=</span> <span class="n">rand</span><span class="p">();</span>
<span class="linenos"> 32</span>        <span class="p">}</span>
<span class="linenos"> 33</span>    <span class="p">}</span>
<span class="linenos"> 34</span>
<span class="linenos"> 35</span>    <span class="k">return</span> <span class="n">accounts</span><span class="p">[</span><span class="n">account_num</span><span class="p">];</span>
<span class="linenos"> 36</span><span class="p">}</span>
<span class="linenos"> 37</span>
<span class="linenos"> 38</span><span class="o">/*</span> <span class="n">This</span> <span class="n">function</span> <span class="ow">is</span> <span class="n">intended</span> <span class="n">so</span> <span class="n">simulate</span> <span class="n">the</span> <span class="n">work</span> <span class="n">of</span> <span class="n">saving</span> <span class="n">the</span> <span class="n">current</span> <span class="n">balance</span>
<span class="linenos"> 39</span> <span class="o">*</span> <span class="n">back</span> <span class="n">to</span> <span class="n">a</span> <span class="n">given</span> <span class="n">account</span> <span class="n">number</span><span class="o">.</span> <span class="n">It</span> <span class="n">just</span> <span class="n">spins</span> <span class="ow">and</span> <span class="n">yields</span> <span class="n">a</span> <span class="n">random</span> <span class="n">number</span> <span class="n">of</span> <span class="n">times</span><span class="o">.</span>
<span class="linenos"> 40</span> <span class="o">*/</span>
<span class="linenos"> 41</span><span class="n">static</span> <span class="n">void</span> <span class="n">put_balance</span><span class="p">(</span><span class="nb">int</span> <span class="n">account_num</span><span class="p">,</span> <span class="n">money_t</span> <span class="n">balance</span><span class="p">)</span>
<span class="linenos"> 42</span><span class="p">{</span>
<span class="linenos"> 43</span>    <span class="n">long</span> <span class="n">dummy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 44</span>    <span class="nb">int</span> <span class="n">nyield</span> <span class="o">=</span> <span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="mi">10</span><span class="p">;</span>
<span class="linenos"> 45</span>    <span class="nb">int</span> <span class="n">nspin</span> <span class="o">=</span> <span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">;</span>
<span class="linenos"> 46</span>
<span class="linenos"> 47</span>
<span class="linenos"> 48</span>    <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nyield</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos"> 49</span>        <span class="n">sched_yield</span><span class="p">();</span>
<span class="linenos"> 50</span>        <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">nspin</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos"> 51</span>            <span class="n">dummy</span> <span class="o">+=</span> <span class="n">rand</span><span class="p">();</span>
<span class="linenos"> 52</span>        <span class="p">}</span>
<span class="linenos"> 53</span>    <span class="p">}</span>
<span class="linenos"> 54</span>
<span class="linenos"> 55</span>    <span class="n">accounts</span><span class="p">[</span><span class="n">account_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">balance</span><span class="p">;</span>
<span class="linenos"> 56</span>    <span class="k">return</span><span class="p">;</span>
<span class="linenos"> 57</span><span class="p">}</span>
<span class="linenos"> 58</span>
<span class="linenos"> 59</span><span class="o">/*</span> <span class="n">Start</span> <span class="n">of</span> <span class="n">deposit</span> <span class="n">function</span> <span class="o">*/</span>
<span class="linenos"> 60</span><span class="n">static</span> <span class="n">void</span> <span class="n">deposit</span><span class="p">(</span><span class="nb">int</span> <span class="n">account</span><span class="p">,</span> <span class="n">money_t</span> <span class="n">amount</span><span class="p">)</span>
<span class="linenos"> 61</span><span class="p">{</span>
<span class="linenos"> 62</span>    <span class="n">money_t</span> <span class="n">balance</span> <span class="o">=</span> <span class="n">get_balance</span><span class="p">(</span><span class="n">account</span><span class="p">);</span>
<span class="linenos"> 63</span>    <span class="n">balance</span> <span class="o">+=</span> <span class="n">amount</span><span class="p">;</span>
<span class="linenos"> 64</span>    <span class="n">put_balance</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">balance</span><span class="p">);</span>
<span class="linenos"> 65</span>
<span class="linenos"> 66</span>    <span class="k">return</span><span class="p">;</span>        
<span class="linenos"> 67</span><span class="p">}</span>
<span class="linenos"> 68</span><span class="o">/*</span> <span class="n">End</span> <span class="n">of</span> <span class="n">deposit</span> <span class="n">function</span> <span class="o">*/</span>
<span class="linenos"> 69</span>
<span class="linenos"> 70</span><span class="n">static</span> <span class="n">void</span> <span class="o">*</span><span class="n">deposit_thread</span><span class="p">(</span><span class="n">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="linenos"> 71</span><span class="p">{</span>
<span class="linenos"> 72</span>    <span class="n">struct</span> <span class="n">deposit_s</span> <span class="o">*</span><span class="n">my_deposit</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span> <span class="n">deposit_s</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
<span class="linenos"> 73</span>    <span class="n">deposit</span><span class="p">(</span><span class="n">my_deposit</span><span class="o">-&gt;</span><span class="n">account_num</span><span class="p">,</span> <span class="n">my_deposit</span><span class="o">-&gt;</span><span class="n">amount</span><span class="p">);</span>
<span class="linenos"> 74</span>
<span class="linenos"> 75</span>    <span class="k">return</span> <span class="p">(</span><span class="n">void</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 76</span><span class="p">}</span>
<span class="linenos"> 77</span>
<span class="linenos"> 78</span><span class="nb">int</span> <span class="n">main</span><span class="p">(</span><span class="nb">int</span> <span class="n">argc</span><span class="p">,</span> <span class="n">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="linenos"> 79</span><span class="p">{</span>
<span class="linenos"> 80</span>    <span class="n">pthread_t</span> <span class="n">tid1</span><span class="p">,</span> <span class="n">tid2</span><span class="p">;</span>
<span class="linenos"> 81</span>    <span class="nb">int</span> <span class="n">account_num</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
<span class="linenos"> 82</span>    <span class="n">money_t</span> <span class="n">amt1</span> <span class="o">=</span> <span class="mf">50.00</span><span class="p">;</span>
<span class="linenos"> 83</span>    <span class="n">money_t</span> <span class="n">amt2</span> <span class="o">=</span> <span class="mf">100.00</span><span class="p">;</span> 
<span class="linenos"> 84</span>
<span class="linenos"> 85</span>    <span class="n">struct</span> <span class="n">deposit_s</span> <span class="n">dep1</span> <span class="o">=</span> <span class="p">{</span><span class="n">account_num</span><span class="p">,</span> <span class="n">amt1</span><span class="p">};</span>
<span class="linenos"> 86</span>    <span class="n">struct</span> <span class="n">deposit_s</span> <span class="n">dep2</span> <span class="o">=</span> <span class="p">{</span><span class="n">account_num</span><span class="p">,</span> <span class="n">amt2</span><span class="p">};</span> 
<span class="linenos"> 87</span>
<span class="linenos"> 88</span>    <span class="o">/*</span> <span class="n">Normally</span> <span class="n">we</span><span class="s1">&#39;d want to test the return value of pthread_create. */</span>
<span class="linenos"> 89</span>
<span class="linenos"> 90</span>    <span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid1</span><span class="p">,</span> <span class="n">NULL</span><span class="p">,</span> <span class="n">deposit_thread</span><span class="p">,</span> <span class="p">(</span><span class="n">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dep1</span> <span class="p">);</span>
<span class="linenos"> 91</span>    <span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid2</span><span class="p">,</span> <span class="n">NULL</span><span class="p">,</span> <span class="n">deposit_thread</span><span class="p">,</span> <span class="p">(</span><span class="n">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dep2</span> <span class="p">);</span>
<span class="linenos"> 92</span>
<span class="linenos"> 93</span>    <span class="o">/*</span> <span class="n">Wait</span> <span class="k">for</span> <span class="n">child</span> <span class="n">threads</span> <span class="n">to</span> <span class="n">finish</span> <span class="o">*/</span>
<span class="linenos"> 94</span>    <span class="n">pthread_join</span><span class="p">(</span><span class="n">tid1</span><span class="p">,</span> <span class="n">NULL</span><span class="p">);</span>
<span class="linenos"> 95</span>    <span class="n">pthread_join</span><span class="p">(</span><span class="n">tid2</span><span class="p">,</span> <span class="n">NULL</span><span class="p">);</span>
<span class="linenos"> 96</span>
<span class="linenos"> 97</span>    <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;Final balance of account #</span><span class="si">%d</span><span class="s2"> after depositing $</span><span class="si">%.2lf</span><span class="s2"> and $</span><span class="si">%.2lf</span><span class="s2"> is $</span><span class="si">%.2lf</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
<span class="linenos"> 98</span>           <span class="n">account_num</span><span class="p">,</span> <span class="n">amt1</span><span class="p">,</span> <span class="n">amt2</span><span class="p">,</span> <span class="n">accounts</span><span class="p">[</span><span class="n">account_num</span><span class="p">]</span> <span class="p">);</span>
<span class="linenos"> 99</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="linenos">100</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "9ea2542c30414663a8ecb365cc8a1e8b", "version_major": 2, "version_minor": 0}
</script></div>
</div>
</section>
<section id="race-conditions">
<h2><span class="section-number">36.4. </span>Race Conditions<a class="headerlink" href="#race-conditions" title="Permalink to this headline">#</a></h2>
<p>The unpredictable and undesirable outcomes that we have seen in the previous examples arise because of <strong>race conditions</strong>.  A race condition occurs whenever two or more threads access a shared resource (like the terminal device, or the variable that stores the bank account balance), and the outcome depends on the order in which the accesses occur. Clearly, this implies that at least one of the accesses must be a write operation, since the outcome of concurrent read operations is not dependent on the order they occur. Logically, the threads are racing with each other to use the resource, and we don’t know which one will come first. Sometimes, the result of the race will be the one we want, and sometimes things can go horribly wrong. Race condition bugs are extremely tricky to diagnose and fix, since the program might produce the correct results millions of times before failing.</p>
<p>Race conditions happen even on a single CPU because asynchronous events occur arbitrarily during thread execution. For example, the network controller raises an interrupt upon arrival of a network packet, which causes the current thread to be suspended while the interrupt handler runs. Or a timer interrupt occurs and the OS scheduler switches the CPU from the current thread to another thread. With multiple CPUs, threads running in parallel on different CPUs can read and write the same memory location. Multi-threaded programs must be designed so that they can execute correctly in the face of such asynchrony.</p>
<p>In our simple example programs, we added extra code to make it more likely for the negative consequences of race conditions to manifest. Without those added operations, the code executed by each thread is short enough to complete in a single time slice, and the threads are less likely to interfere with each other. However, the race condition is still there, lurking in our code.</p>
<p>Consider the example in <a class="reference internal" href="#listing-sync-counter"><span class="std std-numref">Listing 36.4</span></a>, in which two threads either increment or decrement a shared counter some number of times. The arguments to this program let you try different numbers of threads, and different numbers of iterations for each thread to either increment or decrement the shared counter. The program always creates an equal number of incrementing or decrementing threads, and each thread does the same amount of work, so we would expect the final value of the counter to be the same as its initial value when all the threads are done.</p>
<div class="literal-block-wrapper docutils container" id="listing-sync-counter">
<div class="code-block-caption"><span class="caption-number">Listing 36.4 </span><span class="caption-text">counter.c - Two threads increment and decrement a shared counter without synchronization.</span><a class="headerlink" href="#listing-sync-counter" title="Permalink to this code">#</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &lt;pthread.h&gt;</span>
<span class="c1">#include &lt;stdlib.h&gt;</span>
<span class="c1">#include &lt;sys/types.h&gt;</span>
<span class="c1">#include &lt;unistd.h&gt;</span>
<span class="c1">#include &lt;string.h&gt;</span>
<span class="c1">#include &lt;stdio.h&gt;</span>

<span class="n">volatile</span> <span class="n">long</span> <span class="n">shared_counter</span><span class="p">;</span>

<span class="n">static</span> <span class="n">void</span> <span class="o">*</span><span class="n">increment_thread</span><span class="p">(</span><span class="n">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">long</span> <span class="n">niters</span> <span class="o">=</span> <span class="p">(</span><span class="n">long</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">long</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">niters</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">shared_counter</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">void</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">static</span> <span class="n">void</span> <span class="o">*</span><span class="n">decrement_thread</span><span class="p">(</span><span class="n">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">long</span> <span class="n">niters</span> <span class="o">=</span> <span class="p">(</span><span class="n">long</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">long</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">niters</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">shared_counter</span><span class="o">--</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">void</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="nb">int</span> <span class="n">main</span><span class="p">(</span><span class="nb">int</span> <span class="n">argc</span><span class="p">,</span> <span class="n">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">pthread_t</span> <span class="o">*</span><span class="n">tids</span><span class="p">;</span>
    <span class="n">long</span> <span class="n">niters</span><span class="p">;</span>
    <span class="nb">int</span> <span class="n">nthreads</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s2">&quot;Usage: </span><span class="si">%s</span><span class="s2"> &lt;num_threads&gt; &lt;num_iters&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">nthreads</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="n">niters</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
    <span class="n">shared_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    
    <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;Main thread: Beginning test with </span><span class="si">%d</span><span class="s2"> threads</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">nthreads</span><span class="p">);</span>
    
    <span class="n">tids</span> <span class="o">=</span> <span class="p">(</span><span class="n">pthread_t</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">nthreads</span> <span class="o">*</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">pthread_t</span><span class="p">));</span>
    
    <span class="o">/*</span> <span class="n">We</span> <span class="n">create</span> <span class="n">the</span> <span class="n">same</span> <span class="n">number</span> <span class="n">of</span> <span class="n">increment</span> <span class="ow">and</span> <span class="n">decrement</span> <span class="n">threads</span><span class="p">,</span> <span class="n">each</span> <span class="n">doing</span> <span class="n">the</span> <span class="n">same</span> <span class="n">number</span> <span class="n">of</span> <span class="n">iterations</span><span class="o">.</span> 
     <span class="o">*</span> <span class="n">When</span> <span class="nb">all</span> <span class="n">threads</span> <span class="n">have</span> <span class="n">completed</span><span class="p">,</span> <span class="n">we</span> <span class="n">expect</span> <span class="n">the</span> <span class="n">final</span> <span class="n">value</span> <span class="n">of</span> <span class="n">the</span> <span class="n">shared</span> <span class="n">counter</span> <span class="n">to</span> <span class="n">be</span> <span class="n">the</span> <span class="n">same</span> <span class="k">as</span> <span class="n">its</span>
     <span class="o">*</span> <span class="n">initial</span> <span class="n">value</span> <span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span>
     <span class="o">*/</span>
    <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nthreads</span><span class="p">;</span> <span class="n">i</span><span class="o">+=</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tids</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">NULL</span><span class="p">,</span> <span class="n">increment_thread</span><span class="p">,</span> <span class="p">(</span><span class="n">void</span> <span class="o">*</span><span class="p">)</span><span class="n">niters</span> <span class="p">);</span>
        <span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tids</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">NULL</span><span class="p">,</span> <span class="n">decrement_thread</span><span class="p">,</span> <span class="p">(</span><span class="n">void</span> <span class="o">*</span><span class="p">)</span><span class="n">niters</span> <span class="p">);</span>
    <span class="p">}</span>
    
    <span class="o">/*</span> <span class="n">Wait</span> <span class="k">for</span> <span class="n">child</span> <span class="n">threads</span> <span class="n">to</span> <span class="n">finish</span> <span class="o">*/</span>
    <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nthreads</span><span class="p">;</span> <span class="n">i</span><span class="o">+=</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pthread_join</span><span class="p">(</span><span class="n">tids</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">NULL</span><span class="p">);</span>
        <span class="n">pthread_join</span><span class="p">(</span><span class="n">tids</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">NULL</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;Main thread: Final value of shared counter is </span><span class="si">%ld</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">shared_counter</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "5855e960e9654088b89cfd37f091368e", "version_major": 2, "version_minor": 0}
</script></div>
</div>
<p>Even though it looks like the racing thread accesses to the shared counter variable are each just a single line of code, we still have unpredictable final results. The reason is because that single line of C source code, <code class="docutils literal notranslate"><span class="pre">shared_counter++</span></code> or <code class="docutils literal notranslate"><span class="pre">shared_counter--</span></code> becomes three lines of machine code when the program is compiled, as shown in <a class="reference internal" href="#listing-sync-counter-assembly"><span class="std std-numref">Listing 36.5</span></a>. (Try <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">counter.s</span></code>, and see if you can find these lines in the assembly file <code class="docutils literal notranslate"><span class="pre">counter.s</span></code>.) The highlighted lines load the value of the counter from memory into a register, decrement the value in the register, and then store the register value back to memory. Context switches can occur between any of these statements, leading to exactly the same interleaving problems that we saw in the bank account example.</p>
<div class="literal-block-wrapper docutils container" id="listing-sync-counter-assembly">
<div class="code-block-caption"><span class="caption-number">Listing 36.5 </span><span class="caption-text">Assembly code snippet of loop in <code class="docutils literal notranslate"><span class="pre">decrement_thread()</span></code> function.</span><a class="headerlink" href="#listing-sync-counter-assembly" title="Permalink to this code">#</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span>decrement_thread:
<span class="linenos"> 2</span>.LFB63:
<span class="linenos"> 3</span>	.cfi_startproc
<span class="linenos"> 4</span>	endbr64
<span class="linenos"> 5</span>	testq	%rdi, %rdi
<span class="linenos"> 6</span>	jle	.L7
<span class="linenos"> 7</span>	xorl	%edx, %edx
<span class="linenos"> 8</span>	.p2align 4,,10
<span class="linenos"> 9</span>	.p2align 3
<span class="linenos">10</span>.L8:
<span class="hll"><span class="linenos">11</span>	movq	shared_counter(%rip), %rax
</span><span class="linenos">12</span>	addq	$1, %rdx
<span class="hll"><span class="linenos">13</span>	subq	$1, %rax
</span><span class="hll"><span class="linenos">14</span>	movq	%rax, shared_counter(%rip)
</span><span class="linenos">15</span>	cmpq	%rdx, %rdi
<span class="linenos">16</span>	jne	.L8
<span class="linenos">17</span>.L7:
<span class="linenos">18</span>	xorl	%eax, %eax
<span class="linenos">19</span>	ret
<span class="linenos">20</span>	.cfi_endproc
</pre></div>
</div>
</div>
<p>Clearly, uncontrolled sharing can lead to serious problems. In the next chapter, we define the problem a bit more formally. The subsequent chapters look at some ways to solve the problem.</p>
</section>
</section>


<script type="application/vnd.jupyter.widget-state+json">
{"state": {"22f980c9f5124918b071395d9493270f": {"model_module": "@jupyter-widgets/base", "model_module_version": "1.2.0", "model_name": "LayoutModel", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "1.2.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border": "1px solid black", "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": "100%", "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "overflow_x": null, "overflow_y": "scroll", "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "4f54839be1074e6f892b3636f264651b": {"model_module": "@jupyter-widgets/base", "model_module_version": "1.2.0", "model_name": "LayoutModel", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "1.2.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border": "1px solid black", "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": "100%", "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "overflow_x": null, "overflow_y": "scroll", "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "5855e960e9654088b89cfd37f091368e": {"model_module": "@jupyter-widgets/output", "model_module_version": "1.0.0", "model_name": "OutputModel", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/output", "_model_module_version": "1.0.0", "_model_name": "OutputModel", "_view_count": null, "_view_module": "@jupyter-widgets/output", "_view_module_version": "1.0.0", "_view_name": "OutputView", "layout": "IPY_MODEL_97fded72200b444fb6075853681bd96b", "msg_id": "", "outputs": [{"name": "stdout", "output_type": "stream", "text": "$ ./counter 2 20000\r\nMain thread: Beginning test with 2 threads\r\nMain thread: Final value of shared counter is 0\r\n$ ./counter 2 100000\r\nMain thread: Beginning test with 2 threads\r\nMain thread: Final value of shared counter is -89227\r\n$ ./counter 4 100000\r\nMain thread: Beginning test with 4 threads\r\nMain thread: Final value of shared counter is -75354\r\n$ ./counter 4 100000\r\nMain thread: Beginning test with 4 threads\r\nMain thread: Final value of shared counter is -74877\r\n$ "}]}}, "911783af407146c2a3a975b2466092bf": {"model_module": "@jupyter-widgets/output", "model_module_version": "1.0.0", "model_name": "OutputModel", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/output", "_model_module_version": "1.0.0", "_model_name": "OutputModel", "_view_count": null, "_view_module": "@jupyter-widgets/output", "_view_module_version": "1.0.0", "_view_name": "OutputView", "layout": "IPY_MODEL_fa5cc230c05049dd8659604da77a6407", "msg_id": "", "outputs": [{"name": "stdout", "output_type": "stream", "text": "$ [[ -d mydir ]] && rm -rf mydir\r\n$     #\r\n$ "}]}}, "91b2bdf7084c448f9e6e92b658f5b331": {"model_module": "@jupyter-widgets/output", "model_module_version": "1.0.0", "model_name": "OutputModel", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/output", "_model_module_version": "1.0.0", "_model_name": "OutputModel", "_view_count": null, "_view_module": "@jupyter-widgets/output", "_view_module_version": "1.0.0", "_view_name": "OutputView", "layout": "IPY_MODEL_22f980c9f5124918b071395d9493270f", "msg_id": "", "outputs": [{"name": "stdout", "output_type": "stream", "text": "$ ./output_example\r\nHGeooldlbyoe\r\n$ ./output_example\r\nHGeololdboye\r\n$ ./output_example\r\nHGeololdobye\r\n$ ./output_example\r\nHGeloloodbye\r\n$ "}]}}, "97fded72200b444fb6075853681bd96b": {"model_module": "@jupyter-widgets/base", "model_module_version": "1.2.0", "model_name": "LayoutModel", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "1.2.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border": "1px solid black", "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": "100%", "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "overflow_x": null, "overflow_y": "scroll", "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "9ea2542c30414663a8ecb365cc8a1e8b": {"model_module": "@jupyter-widgets/output", "model_module_version": "1.0.0", "model_name": "OutputModel", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/output", "_model_module_version": "1.0.0", "_model_name": "OutputModel", "_view_count": null, "_view_module": "@jupyter-widgets/output", "_view_module_version": "1.0.0", "_view_name": "OutputView", "layout": "IPY_MODEL_4f54839be1074e6f892b3636f264651b", "msg_id": "", "outputs": [{"name": "stdout", "output_type": "stream", "text": "$ ./bank_deposit\r\nFinal balance of account #100 after depositing $50.00 and $100.00 is $150.00\r\n$ ./bank_deposit\r\nFinal balance of account #100 after depositing $50.00 and $100.00 is $150.00\r\n$ ./bank_deposit\r\nFinal balance of account #100 after depositing $50.00 and $100.00 is $100.00\r\n$ ./bank_deposit\r\nFinal balance of account #100 after depositing $50.00 and $100.00 is $150.00\r\n$ ./bank_deposit\r\nFinal balance of account #100 after depositing $50.00 and $100.00 is $150.00\r\n$ "}]}}, "fa5cc230c05049dd8659604da77a6407": {"model_module": "@jupyter-widgets/base", "model_module_version": "1.2.0", "model_name": "LayoutModel", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "1.2.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border": "1px solid black", "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": "100%", "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "overflow_x": null, "overflow_y": "scroll", "padding": null, "right": null, "top": null, "visibility": null, "width": null}}}, "version_major": 2, "version_minor": 0}
</script>


    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./sync"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="sync.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title"><span class="section-number">35. </span>Introduction to Concurrency, Synchronization and Deadlock</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="criticalsection.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">37. </span>The Critical Section Problem</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By (see contributing chapter book)<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>